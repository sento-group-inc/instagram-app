name: Claude AI Project Generator

on:
  repository_dispatch:
    types: [claude-code-requested]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      project_type:
        description: 'プロジェクトタイプ (web, mobile, api など)'
        required: true
        default: 'webapp'
        type: string
      tech_stack:
        description: '技術スタック (react, node.js など)'
        required: true
        default: 'react'
        type: string
      requirements:
        description: 'プロジェクトの要件・説明'
        required: true
        default: 'Instagram-like app with auth, database integration, and enhanced user interface.'
        type: string
      features:
        description: '機能 (auth,database,ui など、カンマ区切り)'
        required: false
        default: 'auth,database,ui'
        type: string
      project_title:
        description: 'プロジェクトタイトル'
        required: true
        default: 'Instagram App Clone'
        type: string
      project_number:
        description: 'プロジェクト番号'
        required: false
        default: '456'
        type: string

permissions:
  contents: write

jobs:
  claude-project-generator:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # プロジェクト設定の取得（n8n・手動実行両対応）
      - name: Get Project Configuration
        id: config
        uses: actions/github-script@v6
        with:
          script: |
            let config = {
              project_type: 'webapp',
              tech_stack: 'react',
              requirements: 'Instagram-like app with auth, database integration, and enhanced user interface.',
              features: 'auth,database,ui',
              generation_mode: 'complete_project',
              project_number: 456,
              project_title: 'Instagram App Clone',
              project_author: 'Experienced Software Team'
            };
            
            if (context.eventName === 'workflow_dispatch') {
              // 手動実行時
              config.project_type = context.payload.inputs?.project_type || 'webapp';
              config.tech_stack = context.payload.inputs?.tech_stack || 'react';
              config.requirements = context.payload.inputs?.requirements || 'Instagram-like app with auth, database integration, and enhanced user interface.';
              config.features = context.payload.inputs?.features || 'auth,database,ui';
              config.project_title = context.payload.inputs?.project_title || 'Instagram App Clone';
              config.project_number = context.payload.inputs?.project_number || 456;
              config.project_author = context.actor || 'Experienced Software Team';
              config.generation_mode = 'complete_project';
            } else if (context.eventName === 'repository_dispatch') {
              // n8nからのrepository_dispatchイベント
              console.log('Full payload:', JSON.stringify(context.payload, null, 2));
              const payload = context.payload.client_payload;
              console.log('Client payload:', JSON.stringify(payload, null, 2));
              
              // n8nのOpenAIノードからのデータ構造に合わせて取得
              config.project_type = payload?.claude_project?.project_type || 'webapp';
              config.tech_stack = payload?.claude_project?.tech_stack || 'react';
              config.requirements = payload?.claude_project?.requirements || 'Instagram-like app with auth, database integration, and enhanced user interface.';
              config.features = payload?.claude_project?.features || 'auth,database,ui';
              config.generation_mode = payload?.claude_project?.generation_mode || 'complete_project';
              config.project_number = payload?.claude_project?.project_number || 456;
              config.project_title = payload?.claude_project?.project_title || 'Instagram App Clone';
              config.project_author = payload?.claude_project?.project_author || 'Experienced Software Team';
              
              console.log('Extracted config:', config);
            }
            
            console.log('Project configuration:', config);
            
            // GitHub Actions outputs設定
            core.setOutput('project_type', config.project_type);
            core.setOutput('tech_stack', config.tech_stack);
            core.setOutput('requirements', config.requirements);
            core.setOutput('features', config.features);
            core.setOutput('generation_mode', config.generation_mode);
            core.setOutput('project_number', config.project_number);
            core.setOutput('project_title', config.project_title);
            core.setOutput('project_author', config.project_author);
            
            return config;

      # プロジェクト構造とファイルの動的生成 (AI使用)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests anthropic

      - name: Generate Project Files with Claude AI
        env:
          ANTHROPIC_API_KEY: "${{ secrets.ANTHROPIC_API_KEY }}"
        run: |
          # APIキーのデバッグ情報
          echo "=== Debug Info ==="
          echo "Raw ANTHROPIC_API_KEY env var: '$ANTHROPIC_API_KEY'"
          echo "Length: ${#ANTHROPIC_API_KEY}"
          echo "First 10 chars: ${ANTHROPIC_API_KEY:0:10}"
          echo "=================="
          
          # APIキーの存在確認
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "❌ ANTHROPIC_API_KEY is not set in GitHub Secrets"
            echo "Please add your Anthropic API key to Repository Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          if [ ${#ANTHROPIC_API_KEY} -lt 10 ]; then
            echo "❌ ANTHROPIC_API_KEY is too short (${#ANTHROPIC_API_KEY} characters)"
            echo "Please check that your API key is correctly set in GitHub Secrets"
            exit 1
          fi
          
          echo "✅ ANTHROPIC_API_KEY is available (length: ${#ANTHROPIC_API_KEY})"
          
          cat > generate_architecture.py << 'EOF'
          import os
          import json
          import requests
          from pathlib import Path
          import time
          
          # プロジェクト設定を読み込み
          config = {
              "type": os.environ.get("PROJECT_TYPE", ""),
              "tech_stack": os.environ.get("TECH_STACK", ""),
              "requirements": os.environ.get("REQUIREMENTS", ""),
              "features": os.environ.get("FEATURES", "basic").split(","),
              "mode": os.environ.get("GENERATION_MODE", "complete_project")
          }
          
          # プロジェクトタイプ別のテンプレート定義
          project_templates = {
              "mobile": {
                  "structure": [
                      "src/components",
                      "src/screens",
                      "src/navigation",
                      "src/services",
                      "src/utils",
                      "src/styles",
                      "assets/images",
                      "assets/fonts"
                  ],
                  "files": {
                      "package.json":              "mobile_package",
                      "App.js":                    "mobile_app",
                      "src/navigation/AppNavigator.js": "navigation",
                      "src/screens/HomeScreen.js":      "home_screen",
                      "src/styles/AppStyles.js":        "mobile_styles",
                      "src/styles/index.js":            "mobile_styles",
                      "src/reportWebVitals.js":    "report_web_vitals"
                  }
              },
              "web": {
                  "structure": [
                      "src/components",
                      "src/pages",
                      "src/hooks",
                      "src/services", 
                      "src/styles",
                      "public"
                  ],
                  "files": {
                      "package.json": "web_package",
                      "src/App.js": "web_app",
                      "src/index.js": "web_index",
                      "src/App.css": "web_app_css",
                      "src/index.css": "web_index_css",
                      "public/index.html": "web_html",
                      "src/reportWebVitals.js":    "report_web_vitals"
                      
                  }
              },
              "api": {
                  "structure": [
                      "src/controllers",
                      "src/models",
                      "src/routes",
                      "src/middleware",
                      "src/utils",
                      "tests"
                  ],
                  "files": {
                      "package.json": "api_package",
                      "src/app.js": "api_app",
                      "src/server.js": "api_server"
                  }
              }
          }
          
          def call_claude_api(prompt, retries=3):
              """Claude APIを呼び出す（リトライ機能付き）"""
              # GitHub Secretsから環境変数を取得
              api_key = os.environ.get("ANTHROPIC_API_KEY")
              
              # APIキーの詳細な検証とクリーニング
              if not api_key:
                  raise Exception("ANTHROPIC_API_KEY environment variable is not set or empty")
              
              # APIキーをクリーニング（先頭・末尾の空白、改行文字を除去）
              original_length = len(api_key)
              api_key = api_key.strip().replace('\\n', '').replace('\\r', '').replace('\\t', '')
              cleaned_length = len(api_key)
              
              print(f"Original API key length: {original_length}")
              print(f"Cleaned API key length: {cleaned_length}")
              print(f"API key starts with: {api_key[:8]}...")
              print(f"API key ends with: ...{api_key[-4:]}")
              
              # 無効な文字のチェック
              invalid_chars = []
              for i, char in enumerate(api_key):
                  if ord(char) < 32 and char not in [' ', '\\t']:
                      invalid_chars.append((i, char, ord(char)))
              
              if invalid_chars:
                  print(f"Found invalid characters at positions: {invalid_chars}")
                  raise Exception(f"API key contains invalid control characters: {invalid_chars}")
              
              # 基本的な形式チェック
              if api_key.startswith("***") or api_key == "YOUR_API_KEY":
                  raise Exception("API key appears to be a placeholder - please set a real Anthropic API key")
              
              if len(api_key) < 10:
                  raise Exception(f"API key too short (length: {len(api_key)}) - please check your ANTHROPIC_API_KEY secret")
              
              # Anthropic APIキーの一般的な形式チェック（sk-で始まる）
              if not api_key.startswith("sk-"):
                  print(f"Warning: API key doesn't start with 'sk-', got: {api_key[:10]}...")
              
              # ASCII文字のみかチェック
              try:
                  api_key.encode('ascii')
                  print("API key contains only ASCII characters ✓")
              except UnicodeEncodeError as e:
                  raise Exception(f"API key contains non-ASCII characters: {e}")
              
              headers = {
                  "x-api-key": api_key,
                  "content-type": "application/json",
                  "anthropic-version": "2023-06-01"
              }
              
              # ヘッダーの検証
              for key, value in headers.items():
                  if not isinstance(value, str):
                      raise Exception(f"Header {key} value is not a string: {type(value)}")
                  # 制御文字のチェック
                  invalid_header_chars = [c for c in value if ord(c) < 32 and c not in [' ', '\\t']]
                  if invalid_header_chars:
                      raise Exception(f"Header {key} contains invalid control characters: {[ord(c) for c in invalid_header_chars]}")
              
              print("Headers validation passed ✓")
              
              data = {
                  "model": "claude-3-5-sonnet-20241022",
                  "max_tokens": 8000,
                  "messages": [{"role": "user", "content": prompt}]
              }
              
              for attempt in range(retries):
                  try:
                      print(f"Calling Claude API (attempt {attempt + 1}/{retries})...")
                      
                      response = requests.post(
                          "https://api.anthropic.com/v1/messages",
                          headers=headers,
                          json=data,
                          timeout=60
                      )
                      
                      if response.status_code == 200:
                          result = response.json()
                          if "content" in result and len(result["content"]) > 0:
                              return result["content"][0]["text"]
                          else:
                              raise Exception("Empty response from Claude API")
                      elif response.status_code == 429:
                          # Rate limit - wait and retry
                          wait_time = 2 ** attempt
                          print(f"Rate limited, waiting {wait_time} seconds...")
                          time.sleep(wait_time)
                          continue
                      else:
                          error_msg = f"API Error {response.status_code}: {response.text}"
                          if attempt == retries - 1:
                              raise Exception(error_msg)
                          print(f"{error_msg}, retrying...")
                          time.sleep(1)
                          
                  except requests.exceptions.RequestException as e:
                      if attempt == retries - 1:
                          raise Exception(f"Network error: {str(e)}")
                      print(f"Network error: {str(e)}, retrying...")
                      time.sleep(1)
              
              raise Exception("All API call attempts failed")
          
          def generate_project_structure():
              """プロジェクト構造を生成"""
              template = project_templates.get(config["type"], project_templates["web"])
              
              # ディレクトリ構造を作成
              for directory in template["structure"]:
                  Path(directory).mkdir(parents=True, exist_ok=True)
                  print(f"Created directory: {directory}")
                  
              return template
          
          def create_fallback_content(file_path, file_type):
              """フォールバック用の基本的なファイル内容を生成"""
              fallback_templates = {
                  "web_package":                   },
                  "web_html": '''
          {
            "name": "claude-generated-project",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "react": "^18.2.0",
              "react-dom": "^18.2.0",
              "react-scripts": "5.0.1"
            },
            "scripts": {
              "start": "react-scripts start",
              "build": "react-scripts build",
              "test": "react-scripts test",
              "eject": "react-scripts eject"
            },
            "browserslist": {
              "production": [">0.2%", "not dead", "not op_mini all"],
              "development": ["last 1 chrome version", "last 1 firefox version", "last 1 safari version"]
            }
          }''',
                  "web_app": '''
          import React from 'react';
          import './App.css';
          
          function App() {
            return (
              <div className="App">
                <header className="App-header">
                  <h1>Claude Generated Project</h1>
                  <p>Welcome to your new application!</p>
                  <div className="features">
                    <h2>Features</h2>
                    <ul>
                      <li>✅ React 18</li>
                      <li>✅ Modern CSS</li>
                      <li>✅ Responsive Design</li>
                      <li>✅ Production Ready</li>
                    </ul>
                  </div>
                </header>
              </div>
            );
          }
          
          export default App;''',
                  "web_index": '''
          import React from 'react';
          import ReactDOM from 'react-dom/client';
          import './index.css';
          import App from './App';
          
          const root = ReactDOM.createRoot(document.getElementById('root'));
          root.render(
            <React.StrictMode>
              <App />
            </React.StrictMode>
          );''',
                  "web_app_css": '''
          .App {
            text-align: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
          }
          
          .App-header {
            padding: 50px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
          }
          
          .App-header h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
          }
          
          .App-header p {
            font-size: 1.2rem;
            margin: 0.5rem 0;
            opacity: 0.9;
          }
          
          .features {
            margin-top: 2rem;
            background: rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
          }
          
          .features h2 {
            margin-bottom: 1rem;
          }
          
          .features ul {
            list-style: none;
            padding: 0;
          }
          
          .features li {
            margin: 0.5rem 0;
            font-size: 1.1rem;
          }
          
          @media (max-width: 768px) {
            .App-header h1 {
              font-size: 2rem;
            }
            .features {
              margin: 1rem;
              padding: 1rem;
            }
          }''',
                  "web_index_css": '''
          body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
              'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
              sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
          }
          
          code {
            font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
              monospace;
          }
          
          * {
            box-sizing: border-box;
          }'''
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <meta name="theme-color" content="#000000" />
              <meta name="description" content="Claude generated web application" />
              <title>Claude Generated App</title>
            </head>
            <body>
              <noscript>You need to enable JavaScript to run this app.</noscript>
              <div id="root"></div>
            </body>
          </html>'''
              }
              
              return fallback_templates.get(file_type, f"// Generated file: {file_path}\\n// TODO: Implement functionality\\n")
          
          def generate_files_with_claude(template):
              """Claude APIを使用してファイルを生成"""
              for file_path, file_type in template["files"].items():
                  prompt = f"""
                  プロジェクト設定:
                  - タイプ: {config["type"]}
                  - 技術スタック: {config["tech_stack"]}
                  - 要件: {config["requirements"]}
                  - 機能: {', '.join(config["features"])}
                  
                  以下のファイルを生成してください: {file_path}
                  ファイルタイプ: {file_type}
                  
                  要求事項:
                  1. 実際に動作するコードを生成
                  2. ベストプラクティスに従う
                  3. コメントを含める
                  4. 設定された機能を反映する
                  5. エラーハンドリングを含める
                  6，重要：決してファイルの中身にバッククオートを含めないこと
                  バッククォート3つで囲まないようにしてください。説明も不要です。
                  
                  ファイル内容のみを返してください。
                  """
                  
                  try:
                      content = call_claude_api(prompt)
                      
                      # ディレクトリが存在しない場合は作成
                      file_dir = Path(file_path).parent
                      file_dir.mkdir(parents=True, exist_ok=True)
                      
                      # ファイルを作成
                      with open(file_path, 'w', encoding='utf-8') as f:
                          f.write(content)
                      
                      print(f"Generated: {file_path}")
                      
                  except Exception as e:
                      print(f"Error generating {file_path}: {e}")
                      print(f"Using fallback content for {file_path}")
                      
                      # フォールバック: 基本的なファイルを作成
                      fallback_content = create_fallback_content(file_path, file_type)
                      
                      file_dir = Path(file_path).parent
                      file_dir.mkdir(parents=True, exist_ok=True)
                      
                      with open(file_path, 'w', encoding='utf-8') as f:
                          f.write(fallback_content)
                      
                      print(f"Created fallback file: {file_path}")
          
          def generate_documentation():
              """READMEドキュメントを生成"""
              prompt = f"""
              以下のプロジェクトの詳細なREADME.mdファイルを生成してください:
              
              プロジェクト設定:
              - タイプ: {config["type"]}
              - 技術スタック: {config["tech_stack"]}
              - 要件: {config["requirements"]}
              - 機能: {', '.join(config["features"])}
              
              README.mdには以下を含めてください:
              1. プロジェクト概要
              2. セットアップ手順
              3. 使用方法
              4. 機能説明
              5. 開発ガイド
              6. ライセンス情報
              
              マークダウン形式で返してください。
              バッククォート3つで囲まないようにしてください。説明も不要です。
              """
              
              try:
                  readme_content = call_claude_api(prompt)
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write(readme_content)
                  print("Generated: README.md")
              except Exception as e:
                  print(f"Error generating README: {e}")
                  print("Creating basic README.md")
                  
                  # フォールバックREADME
                  basic_readme = f"""# {config["type"].title()} Project
          
          ## Overview
          This project was generated using Claude AI.
          
          **Technology Stack:** {config["tech_stack"]}
          **Features:** {', '.join(config["features"])}
          
          ## Setup
          1. Clone this repository
          2. Install dependencies: `npm install`
          3. Start development server: `npm start`
          
          ## Requirements
          {config["requirements"]}
          
          Generated on {time.strftime("%Y-%m-%d %H:%M:%S")}
          """
                  
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write(basic_readme)
                  print("Created basic README.md")
          
          # メイン実行
          def main():
              try:
                  print("Starting project generation...")
                  print(f"Project type: {config['type']}")
                  print(f"Tech stack: {config['tech_stack']}")
                  print(f"Features: {', '.join(config['features'])}")
                  
                  print("\\nGenerating project structure...")
                  template = generate_project_structure()
                  
                  print("\\nGenerating files with Claude...")
                  generate_files_with_claude(template)
                  
                  print("\\nGenerating documentation...")
                  generate_documentation()
                  
                  # 生成サマリーを作成
                  summary = f"""Project Generation Summary
          =========================
          
          Project Type: {config['type']}
          Tech Stack: {config['tech_stack']}
          Features: {', '.join(config['features'])}
          Generation Mode: {config['mode']}
          Generated At: {time.strftime("%Y-%m-%d %H:%M:%S")}
          
          Status: SUCCESS
          
          Files Created:
          """
                  
                  # 作成されたファイルをリスト
                  for root, dirs, files in os.walk("."):
                      for file in files:
                          if not file.startswith('.') and file != 'generate_architecture.py':
                              file_path = os.path.join(root, file)
                              summary += f"- {file_path}\\n"
                  
                  with open("generation_summary.txt", "w", encoding="utf-8") as f:
                      f.write(summary)
                  
                  print("\\n✅ Project generation completed successfully!")
                  
              except Exception as e:
                  error_msg = f"Generation failed: {str(e)}"
                  print(f"\\n❌ {error_msg}")
                  
                  with open("generation_summary.txt", "w", encoding="utf-8") as f:
                      f.write(f"Project Generation Failed\\n")
                      f.write(f"=========================\\n\\n")
                      f.write(f"Error: {error_msg}\\n")
                      f.write(f"Time: {time.strftime('%Y-%m-%d %H:%M:%S')}\\n")
                  
                  raise Exception(error_msg)
          
          if __name__ == "__main__":
              main()
          EOF
          
          # 環境変数をPythonスクリプトに渡す
          export PROJECT_TYPE="${{ steps.config.outputs.project_type }}"
          export TECH_STACK="${{ steps.config.outputs.tech_stack }}"
          export REQUIREMENTS="${{ steps.config.outputs.requirements }}"
          export FEATURES="${{ steps.config.outputs.features }}"
          export PROJECT_TITLE="${{ steps.config.outputs.project_title }}"
          export PROJECT_NUM="${{ steps.config.outputs.project_number }}"
          export PROJECT_AUTHOR="${{ steps.config.outputs.project_author }}"
          export GENERATION_MODE="${{ steps.config.outputs.generation_mode }}"
          
          echo "Environment variables set:"
          echo "  PROJECT_TYPE=$PROJECT_TYPE"
          echo "  TECH_STACK=$TECH_STACK"
          echo "  REQUIREMENTS=$REQUIREMENTS"
          
          python generate_architecture.py

      - name: Commit to Main Branch
        run: |
          PROJECT_TITLE="${{ steps.config.outputs.project_title }}"
          PROJECT_TYPE="${{ steps.config.outputs.project_type }}"
          TECH_STACK="${{ steps.config.outputs.tech_stack }}"
          FEATURES="${{ steps.config.outputs.features }}"
          GENERATION_MODE="${{ steps.config.outputs.generation_mode }}"
          
          git config user.name "claude-bot"
          git config user.email "claude@users.noreply.github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "📝 No changes to commit"
          else
            git commit -m "feat: generate '$PROJECT_TITLE' project
            - Project Type: $PROJECT_TYPE
            - Tech Stack: $TECH_STACK
            - Features: $FEATURES
            - Mode: $GENERATION_MODE
            
            Generated by Claude AI with enhanced project structure and best practices."
            
            git push origin main
          fi

      - name: Success Message
        run: |
          echo "✅ Project generated successfully on main branch!"
          echo "Type: ${{ steps.config.outputs.project_type }}"
          echo "Tech Stack: ${{ steps.config.outputs.tech_stack }}"
          echo "Project: #${{ steps.config.outputs.project_number }}"

  claude-assistant:
    if: |
      github.event_name == 'issue_comment' ||
      github.event_name == 'pull_request_review_comment' ||
      github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      checks: write
      statuses: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.11"

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@beta
        env:
          ANTHROPIC_API_KEY: "${{ secrets.ANTHROPIC_API_KEY }}"
        with:
          anthropic_api_key: "${{ secrets.ANTHROPIC_API_KEY }}"
          github_token: "${{ secrets.GITHUB_TOKEN }}"
          trigger_phrase: "@claude"

  deploy-to-pages:
    if: |
      (github.event_name == 'repository_dispatch' && github.event.action == 'claude-code-requested') &&
      hashFiles('package.json') != ''
    needs: claude-project-generator
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for package.json
        run: |
          echo "=== Debugging package.json location ==="
          pwd
          ls -la
          echo "Looking for package.json..."
          find . -name "package.json" -type f
          echo "=== Current directory contents ==="
          
          if [ ! -f package.json ]; then
            echo "package.json not found in root directory"
            echo "Checking if this is a generated project with package.json..."
            
            # 生成されたプロジェクトをチェック
            if [ -d "src" ] && find . -name "package.json" -type f | grep -q .; then
              echo "Found package.json, proceeding with deployment"
            else
              echo "Error: No package.json found. This might not be a Node.js project. Aborting deployment."
              exit 1
            fi
          else
            echo "✅ package.json found in root directory"
          fi

      - name: Install dependencies
        run: |
          echo "=== Installing dependencies ==="
          if [ -f package.json ]; then
            echo "Found package.json, installing dependencies..."
            npm cache clean --force || true
            rm -f package-lock.json || true
            rm -rf node_modules || true
            npm install
          else
            echo "No package.json found, skipping npm install"
            exit 1
          fi

      - name: Set homepage in package.json
        run: |
          if [ -f package.json ]; then
            npm install -g json
            json -I -f package.json -e "this.homepage=\".\""
          fi

      - name: Build project
        run: |
          echo "=== Building project ==="
          if [ -f package.json ]; then
            echo "Building React application..."
            npm run build
          else
            echo "No package.json found, cannot build project"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          enablement: true
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: |
            ${{ 
              hashFiles('build/**') != '' && './build' || 
              hashFiles('dist/**') != '' && './dist' || 
              hashFiles('public/**') != '' && './public' || 
              '.'
            }}
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

# 手動デプロイ専用ワークフロー
---
name: Manual Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      build_command:
        description: 'ビルドコマンド'
        required: false
        default: 'npm run build'
        type: string
      build_directory:
        description: 'ビルド出力ディレクトリ'
        required: false
        default: 'build'
        type: choice
        options:
          - 'build'
          - 'dist'
          - 'public'
          - '.'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-manual"
  cancel-in-progress: true

jobs:
  manual-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Verify project structure
        run: |
          echo "=== Project Structure Analysis ==="
          pwd
          echo "Current directory contents:"
          ls -la
          echo ""
          echo "Looking for package.json:"
          find . -name "package.json" -type f -exec echo "Found: {}" \;
          echo ""
          echo "Looking for source files:"
          find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" | head -10
          echo ""
          echo "Available directories:"
          find . -type d -maxdepth 2 | sort

      - name: Check package.json
        run: |
          if [ ! -f package.json ]; then
            echo "❌ Error: package.json not found in root directory"
            echo "This appears to be an invalid Node.js project structure"
            echo "Please ensure the project was generated correctly"
            exit 1
          fi
          
          echo "✅ package.json found"
          echo "Package info:"
          cat package.json | jq -r '.name, .version, .scripts'

      - name: Install dependencies
        run: |
          echo "=== Installing Dependencies ==="
          npm cache clean --force
          rm -f package-lock.json
          rm -rf node_modules
          npm install

      - name: Set homepage for GitHub Pages
        run: |
          echo "=== Setting homepage for GitHub Pages ==="
          npm install -g json
          json -I -f package.json -e "this.homepage=\".\""
          echo "Updated package.json homepage field"

      - name: Build project
        run: |
          echo "=== Building Project ==="
          echo "Using build command: ${{ github.event.inputs.build_command }}"
          
          # ビルド前にプロジェクト構造をチェック
          echo "=== Pre-build validation ==="
          if [ -f "src/App.js" ]; then
            echo "✅ App.js found"
            echo "Checking for import issues..."
            
            # すべてのJSファイルでimportエラーをチェック
            find src -name "*.js" -o -name "*.jsx" | while read file; do
              echo "Checking imports in $file..."
              
              # store関連のimportをチェック
              if grep -q "from.*store" "$file"; then
                echo "Found store imports in $file"
                grep "from.*store" "$file"
                
                # 具体的なstore pathを抽出
                store_paths=$(grep -o "from ['\"]\.[^'\"]*store[^'\"]*['\"]" "$file" | sed "s/from ['\"]\([^'\"]*\)['\"]$/\1/")
                
                for store_path in $store_paths; do
                  # パスを正規化 (./ を除去)
                  clean_path=${store_path#./}
                  full_path="src/$clean_path"
                  
                  echo "Checking store path: $full_path"
                  
                  if [ ! -f "$full_path.js" ] && [ ! -f "$full_path/index.js" ] && [ ! -d "$full_path" ]; then
                    echo "❌ Store file not found: $full_path"
                    echo "Creating missing store file..."
                    
                    # ディレクトリ構造を作成
                    mkdir -p "$(dirname "$full_path")"
                    
                    if [[ "$store_path" == *"/store" ]] || [[ "$store_path" == *"/store/store" ]]; then
                      # store/store.js または store.js を作成
                      cat > "$full_path.js" << 'EOF'
import { configureStore } from '@reduxjs/toolkit';
import { createSlice } from '@reduxjs/toolkit';

// User slice
const userSlice = createSlice({
  name: 'user',
  initialState: {
    currentUser: null,
    isLoading: false,
    error: null
  },
  reducers: {
    setUser: (state, action) => {
      state.currentUser = action.payload;
    },
    setLoading: (state, action) => {
      state.isLoading = action.payload;
    },
    setError: (state, action) => {
      state.error = action.payload;
    },
    logout: (state) => {
      state.currentUser = null;
    }
  }
});

// Posts slice
const postsSlice = createSlice({
  name: 'posts',
  initialState: {
    items: [],
    isLoading: false,
    error: null
  },
  reducers: {
    setPosts: (state, action) => {
      state.items = action.payload;
    },
    addPost: (state, action) => {
      state.items.unshift(action.payload);
    },
    setLoading: (state, action) => {
      state.isLoading = action.payload;
    },
    setError: (state, action) => {
      state.error = action.payload;
    }
  }
});

// Configure store
const store = configureStore({
  reducer: {
    user: userSlice.reducer,
    posts: postsSlice.reducer
  }
});

export const { setUser, setLoading, setError, logout } = userSlice.actions;
export const { setPosts, addPost, setLoading: setPostsLoading, setError: setPostsError } = postsSlice.actions;
export default store;
EOF
                    else
                      # 基本的なstore
                      cat > "$full_path.js" << 'EOF'
import { createStore } from 'redux';

const initialState = {
  user: null,
  posts: [],
  loading: false,
  error: null
};

const rootReducer = (state = initialState, action) => {
  switch (action.type) {
    case 'SET_USER':
      return { ...state, user: action.payload };
    case 'SET_POSTS':
      return { ...state, posts: action.payload };
    case 'ADD_POST':
      return { ...state, posts: [action.payload, ...state.posts] };
    case 'SET_LOADING':
      return { ...state, loading: action.payload };
    case 'SET_ERROR':
      return { ...state, error: action.payload };
    case 'LOGOUT':
      return { ...state, user: null };
    default:
      return state;
  }
};

const store = createStore(rootReducer);
export default store;
EOF
                    fi
                    echo "✅ Created store file: $full_path.js"
                  fi
                done
              fi
              
              # コンポーネントimportもチェック
              if grep -q "from.*\./.*" "$file"; then
                component_imports=$(grep -o "from ['\"]\.[^'\"]*['\"]" "$file" | sed "s/from ['\"]\([^'\"]*\)['\"]$/\1/")
                for import_path in $component_imports; do
                  clean_path=${import_path#./}
                  full_path="src/$clean_path"
                  
                  if [ ! -f "$full_path.js" ] && [ ! -f "$full_path.jsx" ] && [ ! -f "$full_path/index.js" ]; then
                    echo "Creating missing component: $full_path.js"
                    mkdir -p "$(dirname "$full_path")"
                    component_name=$(basename "$clean_path")
                    cat > "$full_path.js" << EOF
import React from 'react';

const $component_name = () => {
  return (
    <div className="${component_name,,}-container">
      <h2>$component_name</h2>
      <p>This component was auto-generated to fix build errors.</p>
    </div>
  );
};

export default $component_name;
EOF
                  fi
                done
              fi
            done
          fi
          
          # Redux Toolkit依存関係をチェック
          if grep -r "@reduxjs/toolkit\|configureStore" src/ 2>/dev/null && ! grep -q "@reduxjs/toolkit" package.json; then
            echo "Installing Redux Toolkit..."
            npm install @reduxjs/toolkit react-redux
          elif grep -r "createStore\|redux" src/ 2>/dev/null && ! grep -q "redux" package.json; then
            echo "Installing Redux..."
            npm install redux react-redux
          fi
          
          # ビルドを実行
          echo "Starting build process..."
          if ${{ github.event.inputs.build_command }}; then
            echo "✅ Build completed successfully"
          else
            echo "❌ Build failed, creating minimal fallback..."
            
            # 最小限のビルド可能なアプリを作成
            cat > src/App.js << 'EOF'
import React from 'react';
import './App.css';

function App() {
  return (
    <div className="App">
      <header className="App-header">
        <h1>Instagram Clone</h1>
        <div className="hero-section">
          <p>Welcome to your Instagram-like application!</p>
          <p>This is a minimal version that builds successfully.</p>
        </div>
        <div className="features-grid">
          <div className="feature-card">
            <h3>📱 Mobile Ready</h3>
            <p>Responsive design for all devices</p>
          </div>
          <div className="feature-card">
            <h3>🚀 Fast Loading</h3>
            <p>Optimized for performance</p>
          </div>
          <div className="feature-card">
            <h3>🎨 Modern UI</h3>
            <p>Beautiful and intuitive interface</p>
          </div>
        </div>
      </header>
    </div>
  );
}

export default App;
EOF
            
            cat > src/App.css << 'EOF'
.App {
  text-align: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
}

.App-header {
  padding: 50px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}

.App-header h1 {
  font-size: 4rem;
  margin-bottom: 2rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  background: linear-gradient(45deg, #ffffff, #f0f0f0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hero-section {
  margin-bottom: 3rem;
}

.hero-section p {
  font-size: 1.3rem;
  margin: 1rem 0;
  opacity: 0.9;
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
  max-width: 900px;
  width: 100%;
}

.feature-card {
  background: rgba(255,255,255,0.1);
  padding: 2rem;
  border-radius: 15px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  transition: transform 0.3s ease;
}

.feature-card:hover {
  transform: translateY(-5px);
}

.feature-card h3 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
}

.feature-card p {
  font-size: 1rem;
  opacity: 0.8;
}

@media (max-width: 768px) {
  .App-header h1 {
    font-size: 2.5rem;
  }
  .features-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  .feature-card {
    padding: 1.5rem;
  }
}
EOF
            
            # 最終ビルド試行
            echo "Attempting final build with fallback app..."
            ${{ github.event.inputs.build_command }} || exit 1
          fi

      - name: Verify build output
        run: |
          BUILD_DIR="${{ github.event.inputs.build_directory }}"
          echo "=== Verifying Build Output ==="
          echo "Expected build directory: $BUILD_DIR"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "❌ Build directory '$BUILD_DIR' not found"
            echo "Available directories after build:"
            find . -type d -maxdepth 2
            echo "Trying alternative build directories..."
            
            for dir in build dist public out; do
              if [ -d "$dir" ]; then
                echo "✅ Found alternative build directory: $dir"
                echo "BUILD_DIR=$dir" >> $GITHUB_ENV
                break
              fi
            done
            
            if [ ! -d "${BUILD_DIR}" ]; then
              echo "❌ No suitable build directory found"
              exit 1
            fi
          else
            echo "✅ Build directory '$BUILD_DIR' exists"
            echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
          fi
          
          echo "Build output contents:"
          ls -la "${BUILD_DIR}" || ls -la

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.BUILD_DIR }}

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Success notification
        run: |
          echo "🎉 Deployment completed successfully!"
          echo "🌐 Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "📁 Deployed from directory: ${{ env.BUILD_DIR }}"